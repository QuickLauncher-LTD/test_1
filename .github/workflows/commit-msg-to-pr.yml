name: Update PR Description with Commit Messages and AI Summary

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

jobs:
  update-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get Commit Messages
        id: get-commit-messages
        run: |
          commit_messages=$(git log --reverse --format='%s%n%n%b%nâ‚©â‚©â‚©â‚©â‚©' origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
          echo "$commit_messages"
          
          # Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
          formatted_messages=""
          IFS=$'â‚©â‚©â‚©â‚©â‚©' 
          for message in $commit_messages; do
            message=$(echo "$message" | sed '/^$/d')
            title=$(echo "$message" | head -n 1)
            body=$(echo "$message" | tail -n +2)

            echo "Message: ${message}"
            echo "Title: ${title}"
            echo "Body: ${body}"

            title_trimmed=$(echo "$title" | xargs)
            body_trimmed=$(echo "$body" | xargs)
            
            if [ -z "$title" ]; then
              continue
            fi
            
            if [ ! -z "$body" ]; then
              formatted_messages+="- **$title_trimmed**  %0A> $body_trimmed%0A%0A"
            else
              formatted_messages+="- **$title_trimmed**%0A%0A"
            fi
          done

          echo "$formatted_messages"
          # í¬ë§·íŒ…ëœ ë©”ì‹œì§€ë¥¼ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          formatted_messages="${formatted_messages//'%'/'%25'}"
          formatted_messages="${formatted_messages//$'\n'/'%0A'}"
          formatted_messages="${formatted_messages//$'\r'/'%0D'}"
          echo "::set-output name=messages::$formatted_messages"

        
      - name: Ask ChatGPT for Summary
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > payload.json <<EOF
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "You are a helpful assistant."
              },
              {
                "role": "user",                
                "content": "ë‹¤ìŒì€ ìµœê·¼ GitHub í’€ ë¦¬í€˜ìŠ¤íŠ¸ì— í¬í•¨ëœ ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì…ë‹ˆë‹¤. ì´ ë³€ê²½ ì´ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ, ì½”ë“œ ë¦¬ë·°ì–´ë“¤ì´ ë³€ê²½ ì‚¬í•­ì˜ ëª©ì ê³¼ ì¤‘ìš”í•œ í¬ì¸íŠ¸ë¥¼ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ìš”ì•½í•´ì£¼ì„¸ìš”. ê° ì»¤ë°‹ì˜ ì£¼ìš” ë‚´ìš©ì„ ê°„ëµí•˜ê²Œ ì„¤ëª…í•˜ê³ , ë³€ê²½ ì‚¬í•­ì´ í”„ë¡œì íŠ¸ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì— ëŒ€í•´ ë…¼ì˜í•´ì£¼ì„¸ìš”. ë˜í•œ, ë¦¬ë·°ì–´ë“¤ì´ íŠ¹íˆ ì£¼ì˜ ê¹Šê²Œ ì‚´í´ë´ì•¼ í•  ë¶€ë¶„ì´ ìˆë‹¤ë©´, ê·¸ ë¶€ë¶„ì— ëŒ€í•´ ê°•ì¡°í•´ì£¼ì„¸ìš”. ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n${{ steps.get-commit-messages.outputs.messages }} \n\nì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì½”ë“œ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤ë¥¼ ê°œì„ í•˜ê³ , ë¦¬ë·°ì–´ë“¤ì´ ë³€ê²½ ì‚¬í•­ì˜ ë§¥ë½ì„ ë” ì˜ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”."
              }
            ],
            "temperature": 0.7,
            "max_tokens": 500
          }
          EOF
        
          response=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @payload.json)
          summary=$(echo $response | jq -r '.choices[0].message.content')
          summary="${summary//'%'/'%25'}"
          summary="${summary//$'\n'/'%0A'}"
          summary="${summary//$'\r'/'%0D'}"
          echo "::set-output name=summary::$summary"

      - name: Find and Remove Previous Comment
        if: github.event.action == 'opened'
        env:
          GITHUB_TOKEN: ${{ secrets.DAE_GITHUB_TOKEN }}
        run: |
          comment_id=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json comments -q '.comments[].id' | jq 'select(.body | contains("<!-- AI Summary Marker -->"))' | jq '.id')
          echo "$comment_id"
          if [ ! -z "$comment_id" ]; then
            gh api -X DELETE /repos/${{ github.repository }}/issues/comments/$comment_id
          fi

      
      - name: Update PR description
        if: github.event.action == 'opened'
        env:
          GITHUB_TOKEN: ${{ secrets.DAE_GITHUB_TOKEN }}
        run: |
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)
          COMMIT_MESSAGES_FORMATTED=$(echo "${{ steps.get-commit-messages.outputs.messages }}" | sed 's/%0A/\n/g')
          AI_SUMMARY=$(echo "${{ steps.chatgpt.outputs.summary }}" | sed 's/%0A/\n/g')
          
          UPDATED_DESCRIPTION="
          ---
          <!-- Auto PR Summary Marker -->
          
          # âœ…  PR Check List
          - [ ] Self code review finished
          - [ ] Spotless / static analysis finished
          - [ ] Module test finished
          - [ ] All bugs are fixed

          # ğŸ’»  ì£¼ìš” ê°œë°œ ë‚´ìš©
          #### ì»¤ë°‹ ë©”ì‹œì§€
          ${COMMIT_MESSAGES_FORMATTED}

          # ğŸ¤– AI ìš”ì•½
          ${AI_SUMMARY}

          # âš™ï¸ í…ŒìŠ¤íŠ¸ ë‚´ìš© (ëª¨ë“ˆê²€ì¦)

          # âš™ï¸ í…ŒìŠ¤íŠ¸ ë‚´ìš© (í†µí•©ê²€ì¦)
          - ë¡œì»¬ í†µí•© í…ŒìŠ¤íŠ¸

          # â“ Known issue
          - ì—†ìŒ

          # ğŸ™ To Reviewer
          - ì—†ìŒ

          # ğŸ« Ticket 
          "

          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"

          
      - name: Update PR description with markers
        if: (github.event.action == 'synchronize' || github.event.action == 'reopened')
        env:
          GITHUB_TOKEN: ${{ secrets.DAE_GITHUB_TOKEN }}
        run: |
          # ê¸°ì¡´ PR ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)
          
          # ì»¤ë°‹ ë©”ì‹œì§€ì™€ AI ìš”ì•½ì„ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•œ ìƒˆë¡œìš´ ë‚´ìš©
          NEW_COMMIT_MESSAGES=$(echo "${{ steps.get-commit-messages.outputs.messages }}" | sed 's/%0A/\n/g')
          NEW_AI_SUMMARY=$(echo "${{ steps.chatgpt.outputs.summary }}" | sed 's/%0A/\n/g')
          
          # ë§ˆì»¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ì„¤ëª…ì—ì„œ ì»¤ë°‹ ë©”ì‹œì§€ì™€ AI ìš”ì•½ ì„¹ì…˜ì„ ì‹ë³„
          BEFORE_COMMIT_MESSAGES=$(echo "$PR_DESCRIPTION" | sed -n '/<!-- Auto PR Summary Marker -->/,/#### ì»¤ë°‹ ë©”ì‹œì§€/p' | sed '$d')
          AFTER_AI_SUMMARY=$(echo "$PR_DESCRIPTION" | sed -n '/# â“ Known issue/,$p')

          # ìƒˆë¡œìš´ PR ì„¤ëª… ìƒì„±
          UPDATED_DESCRIPTION="${BEFORE_COMMIT_MESSAGES}
          #### ì»¤ë°‹ ë©”ì‹œì§€
          ${NEW_COMMIT_MESSAGES}

          # ğŸ¤– AI ìš”ì•½
          ${NEW_AI_SUMMARY}
          
          ${AFTER_AI_SUMMARY}"

          # PR ì„¤ëª… ì—…ë°ì´íŠ¸
          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"
