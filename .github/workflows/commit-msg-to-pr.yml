name: Update PR Description with Commit Messages

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

jobs:
  update-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get Commit Messages
        id: get-commit-messages
        run: |
          # PR의 베이스 브랜치와 HEAD 브랜치 간의 커밋 메시지 추출
          commit_messages=$(git log --reverse --format=%B origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
          commit_messages="${commit_messages//'%'/'%25'}"
          commit_messages="${commit_messages//$'\n'/'%0A'}"
          commit_messages="${commit_messages//$'\r'/'%0D'}"
          echo "::set-output name=messages::$commit_messages"

      - name: Update PR description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 현재 PR의 설명을 가져옵니다.
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)

          # 새로운 내용을 추가합니다. 여기에 원하는 텍스트를 추가하세요.
          UPDATED_DESCRIPTION="${PR_DESCRIPTION}
          ---
          
          ✅  PR Check List
          - [] Self code review finished
          - [] Spotless / static analysis finished
          - [] Module test finished
          - [] All bugs are fixed

          💻  주요 개발 내용
          ### 커밋 내용
          ${{ steps.get-commit-messages.outputs.messages }}
          

          ⚙️ 테스트 내용 (모듈검증)

          ⚙️ 테스트 내용 (통합검증)
          - 로컬 통합 테스트

          ❓ Known issue
          - 없음

          🙏 To Reviewer
          - 쿼리파라미터 입력 추가 건입니다. 로직은 동일합니다.

          🎫 Ticket 
          [CMP-551]: https://lgu-cto.atlassian.net/browse/CMP-551
          [CMP-552]: https://lgu-cto.atlassian.net/browse/CMP-552"

          # PR의 설명을 업데이트합니다.
          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"

      - name: Ask ChatGPT
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          response=$(curl -s -X POST "https://api.openai.com/v1/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            --data '{
              "model": "text-davinci-003",
              "prompt": "다음은 GitHub Commit 메시지이다. 요약해줘 \n $commit_messages",
              "temperature": 0.7,
              "max_tokens": 150
            }')
          answer=$(echo $response | jq -r '.choices[0].text')
          echo "::set-output name=answer::$answer"

      - name: Update PR description with ChatGPT response
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)
          UPDATED_DESCRIPTION="${PR_DESCRIPTION}\n\n### ChatGPT Response\n${{ steps.chatgpt.outputs.answer }}"

          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"
