name: Update PR Description with Commit Messages

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

jobs:
  update-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Get Commit Messages
        id: get-commit-messages
        run: |
          commit_messages=$(git log --reverse --format=%B origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
          commit_messages="${commit_messages//'%'/'%25'}"
          commit_messages="${commit_messages//$'\n'/'%0A'}"
          commit_messages="${commit_messages//$'\r'/'%0D'}"
          echo "::set-output name=messages::$commit_messages"

      - name: Ask ChatGPT
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # JSON ìš”ì²­ ë³¸ë¬¸ì„ íŒŒì¼ë¡œ ìž‘ì„±
          cat > payload.json <<EOF
          {
            "model": "text-davinci-003",
            "prompt": "ë‹¤ìŒì€ GitHub Commit ë©”ì‹œì§€ì´ë‹¤. ìš”ì•½í•´ì¤˜:\n${{ steps.get-commit-messages.outputs.messages }}",
            "temperature": 0.7,
            "max_tokens": 150
          }
          EOF
        
          # íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ OpenAIì— ìš”ì²­
          response=$(curl -s -X POST "https://api.openai.com/v1/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @payload.json)
          echo "Response: $response"
          summary=$(echo $response | jq -r '.choices[0].text')
          echo "::set-output name=summary::$summary"
        # run: |
        #   echo "Requesting summary from OpenAI..."
        #   response=$(curl -s -X POST "https://api.openai.com/v1/completions" \
        #     -H "Content-Type: application/json" \
        #     -H "Authorization: Bearer $OPENAI_API_KEY" \
        #     --data "{
        #       \"model\": \"text-davinci-003\",
        #       \"prompt\": \"ë‹¤ìŒì€ GitHub Commit ë©”ì‹œì§€ì´ë‹¤. ìš”ì•½í•´ì¤˜:\\n${{ steps.get-commit-messages.outputs.messages }}\",
        #       \"temperature\": 0.7,
        #       \"max_tokens\": 150
        #     }")
        #   echo "Response: $response"
        #   summary=$(echo $response | jq -r '.choices[0].text')
        #   echo "::set-output name=summary::$summary"

          
      - name: Update PR description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)
          UPDATED_DESCRIPTION="${PR_DESCRIPTION}
          ---

          âœ…  PR Check List
          - [ ] Self code review finished
          - [ ] Spotless / static analysis finished
          - [ ] Module test finished
          - [ ] All bugs are fixed

          ðŸ’»  ì£¼ìš” ê°œë°œ ë‚´ìš©
          ### ì»¤ë°‹ ìš”ì•½
          ${{ steps.chatgpt.outputs.summary }}

          âš™ï¸ í…ŒìŠ¤íŠ¸ ë‚´ìš© (ëª¨ë“ˆê²€ì¦)

          âš™ï¸ í…ŒìŠ¤íŠ¸ ë‚´ìš© (í†µí•©ê²€ì¦)
          - ë¡œì»¬ í†µí•© í…ŒìŠ¤íŠ¸

          â“ Known issue
          - ì—†ìŒ

          ðŸ™ To Reviewer
          - ì¿¼ë¦¬íŒŒë¼ë¯¸í„° ìž…ë ¥ ì¶”ê°€ ê±´ìž…ë‹ˆë‹¤. ë¡œì§ì€ ë™ì¼í•©ë‹ˆë‹¤.

          ðŸŽ« Ticket 
          [CMP-551]: https://lgu-cto.atlassian.net/browse/CMP-551
          [CMP-552]: https://lgu-cto.atlassian.net/browse/CMP-552"

          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"
