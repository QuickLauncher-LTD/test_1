name: Update PR Description with Commit Messages and AI Summary

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

jobs:
  update-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Get Commit Messages
        id: get-commit-messages
        # run: |
        #   commit_messages=$(git log --reverse --format='%B%n' origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
        #   commit_messages="${commit_messages//'%'/'%25'}"
        #   commit_messages="${commit_messages//$'\n'/'%0A'}"
        #   commit_messages="${commit_messages//$'\r'/'%0D'}"
        #   echo "::set-output name=messages::$commit_messages"
        run: |
          # 커밋 메시지 추출
          IFS=$'\n' read -r -d '' -a commit_lines < <(git log --reverse --format='%B%n%n%n' origin/${{ github.base_ref }}..origin/${{ github.head_ref }} && printf '\0')
          
          formatted_messages=""
          for line in "${commit_lines[@]}"; do
            if [[ "$line" == "feat: "* || "$line" == "fix: "* || "$line" == "chor: "* || "$line" == "config: "* ]]; then
              # 타이틀 처리
              if [ ! -z "$formatted_messages" ]; then
                formatted_messages+='\n\n' # 이전 메시지와의 구분
              fi
              formatted_messages+="**$line**"
            elif [ ! -z "$line" ]; then
              # 바디 처리
              if [[ "$formatted_messages" == *\*\*** ]]; then
                formatted_messages+="\n> $line"
              else
                formatted_messages+="\n\n> $line"
              fi
            fi
          done
      
          # 포맷팅된 메시지를 출력 변수로 설정
          formatted_messages="${formatted_messages//'%'/'%25'}"
          formatted_messages="${formatted_messages//$'\n'/'%0A'}"
          formatted_messages="${formatted_messages//$'\r'/'%0D'}"
          echo "::set-output name=messages::$formatted_messages"

          
      - name: Ask ChatGPT for Summary
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > payload.json <<EOF
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "You are a helpful assistant."
              },
              {
                "role": "user",
                "content": "다음은 GitHub에서의 최근 커밋 메시지들입니다. 각 커밋의 제목과 본문을 요약하고, 전체적인 변경 사항에 대한 개요를 제공해주세요. 커밋 메시지 당 숫자로 구분합니다. MD 파일 양식에 맞게, 각 커밋의 제목은 볼드(**)로 표시하고, 본문은 인용구(>)로 표시합니다. 커밋 메시지들은 다음과 같습니다:\n${{ steps.get-commit-messages.outputs.messages }}"
              }
            ],
            "temperature": 0.7,
            "max_tokens": 500
          }
          EOF
        
          response=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @payload.json)
          summary=$(echo $response | jq -r '.choices[0].message.content')
          summary="${summary//'%'/'%25'}"
          summary="${summary//$'\n'/'%0A'}"
          summary="${summary//$'\r'/'%0D'}"
          echo "::set-output name=summary::$summary"

      - name: Find and Remove Previous Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          comment_id=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json comments -q '.comments[].id' | jq 'select(.body | contains("<!-- AI Summary Marker -->"))' | jq '.id')
          echo "$comment_id"
          if [ ! -z "$comment_id" ]; then
            gh api -X DELETE /repos/${{ github.repository }}/issues/comments/$comment_id
          fi

      
      - name: Update PR description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)
          COMMIT_MESSAGES_FORMATTED=$(echo "${{ steps.get-commit-messages.outputs.messages }}" | sed 's/%0A/\n/g')
          AI_SUMMARY=$(echo "${{ steps.chatgpt.outputs.summary }}" | sed 's/%0A/\n/g')
          
          UPDATED_DESCRIPTION="
          ---
          <!-- Auto PR Summary Marker -->
          
          # ✅  PR Check List
          - [ ] Self code review finished
          - [ ] Spotless / static analysis finished
          - [ ] Module test finished
          - [ ] All bugs are fixed

          # 💻  주요 개발 내용
          #### 커밋 메시지
          ${COMMIT_MESSAGES_FORMATTED}

          # 🤖 AI 요약
          ${AI_SUMMARY}

          # ⚙️ 테스트 내용 (모듈검증)

          # ⚙️ 테스트 내용 (통합검증)
          - 로컬 통합 테스트

          # ❓ Known issue
          - 없음

          # 🙏 To Reviewer
          - 없음

          # 🎫 Ticket 
          "

          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"
