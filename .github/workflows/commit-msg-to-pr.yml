name: Update PR Description with Commit Messages and AI Summary

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

jobs:
  update-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Get Commit Messages
        id: get-commit-messages
        # run: |
        #   # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
        #   commit_messages=$(git log --reverse --format='%B%n' origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
          
        #   # Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
        #   formatted_messages=""
        #   IFS=$'\n\n' # ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì„ ë¶„ë¦¬í•˜ëŠ” êµ¬ë¶„ìë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        #   for message in $commit_messages; do
        #     # ì»¤ë°‹ ë©”ì‹œì§€ì˜ ì²« ì¤„(ì œëª©)ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
        #     title=$(echo "$message" | head -n 1)
        #     # ì»¤ë°‹ ë©”ì‹œì§€ì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„(ë³¸ë¬¸)ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
        #     body=$(echo "$message" | tail -n +2)
            
        #     # Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
        #     if [ ! -z "$body" ]; then
        #       formatted_messages+="- **$title**\n  - $body\n\n"
        #     else
        #       formatted_messages+="- **$title**\n\n"
        #     fi
        #   done
          
        #   # í¬ë§·íŒ…ëœ ë©”ì‹œì§€ë¥¼ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        #   formatted_messages="${formatted_messages//'%'/'%25'}"
        #   formatted_messages="${formatted_messages//$'\n'/'%0A'}"
        #   formatted_messages="${formatted_messages//$'\r'/'%0D'}"
        #   echo "::set-output name=formatted_messages::$formatted_messages"
        run: |
          IFS=$'\n\n' # ì»¤ë°‹ ë©”ì‹œì§€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
          commit_messages=$(git log --reverse --format='%B%n' origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
          formatted_messages=""
        
          readarray -t messages <<<"$commit_messages" # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
          for message in "${messages[@]}"; do
            if [[ -z "$message" ]]; then
              continue # ë¹ˆ ë©”ì‹œì§€ëŠ” ê±´ë„ˆëœë‹ˆë‹¤.
            fi
            
            # ì œëª©ê³¼ ë³¸ë¬¸ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤.
            title=$(echo "$message" | head -n1)
            body=$(echo "$message" | tail -n +2)
            
            # ë³¸ë¬¸ì´ ìˆëŠ” ê²½ìš°, ë³¸ë¬¸ì˜ ê° í•­ëª©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            if [[ ! -z "$body" ]]; then
              body_lines=""
              IFS=$'\n' # ë³¸ë¬¸ ë‚´ë¶€ì˜ ê°œí–‰ìœ¼ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
              readarray -t lines <<<"$body"
              for line in "${lines[@]}"; do
                if [[ -z "$line" ]]; then
                  continue
                fi
                body_lines+="  - $line\n"
              done
              formatted_messages+="- **$title**\n$body_lines\n"
            else
              formatted_messages+="- **$title**\n\n"
            fi
          done
        
          # í¬ë§·íŒ…ëœ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ GitHub Actionsì˜ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          formatted_messages="${formatted_messages//'%'/'%25'}"
          formatted_messages="${formatted_messages//$'\n'/'%0A'}"
          formatted_messages="${formatted_messages//$'\r'/'%0D'}"
          echo "::set-output name=messages::$formatted_messages"
        # run: |
        #   commit_messages=$(git log --reverse --format='%B%n' origin/${{ github.base_ref }}..origin/${{ github.head_ref }})
        #   commit_messages="${commit_messages//'%'/'%25'}"
        #   commit_messages="${commit_messages//$'\n'/'%0A'}"
        #   commit_messages="${commit_messages//$'\r'/'%0D'}"
        #   echo "::set-output name=messages::$commit_messages"
          
      - name: Ask ChatGPT for Summary
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > payload.json <<EOF
          {
            "model": "gpt-3.5-turbo",
            "messages": [
              {
                "role": "system",
                "content": "You are a helpful assistant."
              },
              {
                "role": "user",
                "content": "ë‹¤ìŒì€ GitHubì—ì„œì˜ ìµœê·¼ ì»¤ë°‹ ë©”ì‹œì§€(title, body)ë“¤ì…ë‹ˆë‹¤. ê° ì»¤ë°‹ì˜ ë‚´ìš©ì„ ìš”ì•½í•˜ê³ , ì „ì²´ì ì¸ ë³€ê²½ ì‚¬í•­ì— ëŒ€í•œ ê°œìš”ë¥¼ í•œ ì¤„ë¡œ ì œê³µí•´ì£¼ì„¸ìš”. MDíŒŒì¼ ì–‘ì‹ìœ¼ë¡œ ì‘ì„±ë˜ë¯€ë¡œ titleì€ -**[TITLE]**, bodyëŠ” >[BODY] ê·œê²©ì— ë§ê²Œ ì‘ì„±í•©ë‹ˆë‹¤. ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n${{ steps.get-commit-messages.outputs.messages }}"
              }
            ],
            "temperature": 0.7,
            "max_tokens": 250
          }
          EOF
        
          response=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @payload.json)
          summary=$(echo $response | jq -r '.choices[0].message.content')
          summary="${summary//'%'/'%25'}"
          summary="${summary//$'\n'/'%0A'}"
          summary="${summary//$'\r'/'%0D'}"
          echo "::set-output name=summary::$summary"

      - name: Find and Remove Previous Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          comment_id=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json comments -q '.comments[].id' | jq 'select(.body | contains("<!-- AI Summary Marker -->"))' | jq '.id')
          echo "$comment_id"
          if [ ! -z "$comment_id" ]; then
            gh api -X DELETE /repos/${{ github.repository }}/issues/comments/$comment_id
          fi

      
      - name: Update PR description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DESCRIPTION=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json body -q .body)
          COMMIT_MESSAGES_FORMATTED=$(echo "${{ steps.get-commit-messages.outputs.messages }}" | sed 's/%0A/\n/g')
          AI_SUMMARY=$(echo "${{ steps.chatgpt.outputs.summary }}" | sed 's/%0A/\n/g')
          
          UPDATED_DESCRIPTION="
          ---
          <!-- Auto PR Summary Marker -->
          
          # âœ…  PR Check List
          - [ ] Self code review finished
          - [ ] Spotless / static analysis finished
          - [ ] Module test finished
          - [ ] All bugs are fixed

          # ğŸ’»  ì£¼ìš” ê°œë°œ ë‚´ìš©
          #### ì»¤ë°‹ ë©”ì‹œì§€
          \`\`\`
          ${COMMIT_MESSAGES_FORMATTED}
          \`\`\`

          # ğŸ¤– AI ìš”ì•½
          ${AI_SUMMARY}

          # âš™ï¸ í…ŒìŠ¤íŠ¸ ë‚´ìš© (ëª¨ë“ˆê²€ì¦)

          # âš™ï¸ í…ŒìŠ¤íŠ¸ ë‚´ìš© (í†µí•©ê²€ì¦)
          - ë¡œì»¬ í†µí•© í…ŒìŠ¤íŠ¸

          # â“ Known issue
          - ì—†ìŒ

          # ğŸ™ To Reviewer
          - ì—†ìŒ

          # ğŸ« Ticket 
          "

          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$UPDATED_DESCRIPTION"
